
## 事件
　　Redis 服务器是一个事件驱动程序 ，服务器需要处理文件事件和时间事件这两类事件。

### 文件事件
　　Redis 服务器通过套接字与客户端（或其它 Redis 服务器）进行连接，而文件事件就是服务器对套接字操作的抽象。服务器与客户端（或其它服务器） 的通信会产生相应的文件事件，服务器通过监听并处理这些事件来完成一系列网络通信操作。

#### 文件事件处理器的构成
　　Redis 基于 Reactor 模式开发了网络事件处理器，又称为文件事件处理器。虽然文件事件处理器以单线程方式运行，但通过使用 I / O 多路复用程序来监听多个套接字，文件事件处理器既实现了高性能的网络通信模型，又很好与 Redis 服务器中其它同样以单线程方式运行的模块进行对接，保存了 Redis 内部单线程设计的简单性。<br />
　　文件事件处理器由四个部分组成，分布是套接字、I / O 多路复用程序、文件事件分派器以及事件处理器。
  
![Aaron Swartz](https://raw.githubusercontent.com/martin-1992/redis_notebook/master/chapter_12/chapter_12_p1.png)
  
- 文件事件是对套接字操作的抽象，每当一个套接字准备好执行连接应答、读取、写入、关闭等操作时，就会产生一个文件事件，因为一个服务器通常会连接多个套接字，所以多个文件事件可能会并发出现；

- I / O 多路复用程序负责监听多个套接字，并向文件事件分派器传送那些产生了事件的套接字。尽管多个文件事件可能会并发出现，但 I / O 多路复用程序总是会将所有产生事件的套接字都放到一个队列里，然后通过这个队列，以有序、同步、每次一个套接字的方式向文件事件分派器传送套接字。当上一个套接字产生的事件被处理完之后，才会传送下一个套接字。

![Aaron Swartz](https://raw.githubusercontent.com/martin-1992/redis_notebook/master/chapter_12/chapter_12_p2.png)

- 文件事件分派器接收 I / O 多路复用程序传来的套接字，并根据套接字产生的事件类型，调用相应的事件处理器，如连接应答操作，则调用连接应答处理器。如果一个套接字又可读又可写的话，那么服务器将先读套接字，后写套接字；
- 服务器会为执行不同任务的套接字关联不同的事件处理器，这些处理器是一个个函数，定义了某个时间发生时，服务器应执行的动作。

　　以一次 Redis 客户端与服务器进行连接并发送命令的过程为例，看看过程中产生什么事件，以及如何处理。

![Aaron Swartz](https://raw.githubusercontent.com/martin-1992/redis_notebook/master/chapter_12/chapter_12_p3.png)

### 时间事件
　　Redis 的时间事件分为两类：
- 定时事件，让一段程序在指定时间之后执行一次，如在当前时间的 30 秒后执行一次；
- 周期性时间，每隔一段时间执行一次，如每隔 30 秒执行一次。

　　一个时间事件由以下三个属性组成：
- id，服务器为时间事件创建的全局唯一 ID（标识号），从小到大顺序递增，ID 号越大，表明为新事件；
- when，毫秒精度  UNIX 时间戳，记录时间事件的到达时间；
- timeProc，时间事件处理器，一个函数，用于处理时间事件。

　　服务器将所有时间事件放在一个无序链表里，这里的无序指的是不按 when 排序。每次运行时间事件执行器时，就遍历整个链表，查找所有已到达的时间事件，调用相应的事件处理器。如下为包含三个不同的时间事件的链表，新的时间事件总是插入到链表表头：
  
![Aaron Swartz](https://raw.githubusercontent.com/martin-1992/redis_notebook/master/chapter_12/chapter_12_p4.png)

#### 时间事件应用实例，serverCron 函数
　　服务器在一般情况下主要工作：
- 更新服务器的各类统计信息，比如时间、内存占用、数据库占用情况等；
- 清理数据库中的过期键值对；
- 关闭和清理连接失效的客户端；
- 尝试进行 AOF 或 RDB 持久化操作；
- 如果服务器是主服务器，对从服务器进行定期同步；
- 如果处于集群模式，对集群进行定期同步和连接测试。

### 事件的调度与执行
　　因为服务器中同时存在文件事件和时间事件两种时间类型，所以服务器必须对这两种事件进行调度。
  
![Aaron Swartz](https://raw.githubusercontent.com/martin-1992/redis_notebook/master/chapter_12/chapter_12_p5.png)

　　下面是事件的调度和执行规则：
- aeApiPoll 函数的最大阻塞时间由到达时间最接近当前时间的时间事件决定，这样可避免服务器对时间事件进行频繁的轮询（忙等待），确保 aeApiPoll 函数不会阻塞过长时间；
- 因为文件事件是随机出现的，当处理完一次文件事件后，如没有时间事件到达，则服务器再次等待并处理文件事件，直到时间事件到达时间，则处理已到达的时间事件；
- 对文件事件和时间事件的处理都是同步、有序、原子地执行，不会中途中断时间处理，也不会对事件进行抢占。因此，文件事件处理器和时间处理器都会尽量减少程序的阻塞时间，并在有需要时主动让出执行权。另外，时间事件也会将非常耗时的持久化操作放到子进程执行；
- 因为时间事件在文件事件之后执行，并且事件之间不会出现抢占，所以时间事件的实际处理时间，通常比时间事件设定的到达时间要晚一些。
